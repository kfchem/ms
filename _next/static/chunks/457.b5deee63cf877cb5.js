"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[457],{9457:(e,t,s)=>{s.d(t,{GLTFExporter:()=>i});var r=s(5339);let n={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class i{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(e){return new y(e)}),this.register(function(e){return new x(e)}),this.register(function(e){return new M(e)}),this.register(function(e){return new b(e)}),this.register(function(e){return new E(e)}),this.register(function(e){return new R(e)}),this.register(function(e){return new T(e)}),this.register(function(e){return new w(e)}),this.register(function(e){return new A(e)}),this.register(function(e){return new I(e)}),this.register(function(e){return new N(e)}),this.register(function(e){return new S(e)}),this.register(function(e){return new _(e)}),this.register(function(e){return new L(e)})}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,s,r){let n=new g,i=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)i.push(this.pluginCallbacks[e](n));n.setPlugins(i),n.setTextureUtils(this.textureUtils),n.writeAsync(e,t,r).catch(s)}parseAsync(e,t){let s=this;return new Promise(function(r,n){s.parse(e,r,n,t)})}}let a={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},o="KHR_mesh_quantization",l={};l[r.hxR]=a.NEAREST,l[r.pHI]=a.NEAREST_MIPMAP_NEAREST,l[r.Cfg]=a.NEAREST_MIPMAP_LINEAR,l[r.k6q]=a.LINEAR,l[r.kRr]=a.LINEAR_MIPMAP_NEAREST,l[r.$_I]=a.LINEAR_MIPMAP_LINEAR,l[r.ghU]=a.CLAMP_TO_EDGE,l[r.GJx]=a.REPEAT,l[r.kTW]=a.MIRRORED_REPEAT;let c={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},h=new r.Q1f;function u(e,t){return e.length===t.length&&e.every(function(e,s){return e===t[s]})}function p(e){return 4*Math.ceil(e/4)}function m(e,t=0){let s=p(e.byteLength);if(s!==e.byteLength){let r=new Uint8Array(s);if(r.set(new Uint8Array(e)),0!==t)for(let n=e.byteLength;n<s;n++)r[n]=t;return r.buffer}return e}function f(){return"undefined"==typeof document&&"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}function d(e,t){let s;return void 0!==e.toBlob?new Promise(s=>e.toBlob(s,t)):("image/jpeg"===t?s=.92:"image/webp"===t&&(s=.8),e.convertToBlob({type:t,quality:s}))}class g{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+r.sPf}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,s={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},s),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);let r=this.buffers,n=this.json;s=this.options;let i=this.extensionsUsed,a=this.extensionsRequired,o=new Blob(r,{type:"application/octet-stream"}),l=Object.keys(i),c=Object.keys(a);if(l.length>0&&(n.extensionsUsed=l),c.length>0&&(n.extensionsRequired=c),n.buffers&&n.buffers.length>0&&(n.buffers[0].byteLength=o.size),!0===s.binary){let e=new FileReader;e.readAsArrayBuffer(o),e.onloadend=function(){var s;let r=m(e.result),i=new DataView(new ArrayBuffer(8));i.setUint32(0,r.byteLength,!0),i.setUint32(4,5130562,!0);let a=m((s=JSON.stringify(n),new TextEncoder().encode(s).buffer),32),o=new DataView(new ArrayBuffer(8));o.setUint32(0,a.byteLength,!0),o.setUint32(4,0x4e4f534a,!0);let l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,0x46546c67,!0),c.setUint32(4,2,!0);let h=12+o.byteLength+a.byteLength+i.byteLength+r.byteLength;c.setUint32(8,h,!0);let u=new Blob([l,o,a,i,r],{type:"application/octet-stream"}),p=new FileReader;p.readAsArrayBuffer(u),p.onloadend=function(){t(p.result)}}}else if(n.buffers&&n.buffers.length>0){let e=new FileReader;e.readAsDataURL(o),e.onloadend=function(){let s=e.result;n.buffers[0].uri=s,t(n)}}else t(n)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;let s=this.options,r=this.extensionsUsed;try{let n=JSON.parse(JSON.stringify(e.userData));if(s.includeCustomExtensions&&n.gltfExtensions){for(let e in void 0===t.extensions&&(t.extensions={}),n.gltfExtensions)t.extensions[e]=n.gltfExtensions[e],r[e]=!0;delete n.gltfExtensions}Object.keys(n).length>0&&(t.extras=n)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){let t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;let t=new r.Pq0;for(let s=0,r=e.count;s<r;s++)if(Math.abs(t.fromBufferAttribute(e,s).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let s=e.clone(),n=new r.Pq0;for(let e=0,t=s.count;e<t;e++)n.fromBufferAttribute(s,e),0===n.x&&0===n.y&&0===n.z?n.setX(1):n.normalize(),s.setXYZ(e,n.x,n.y,n.z);return t.attributesNormalized.set(e,s),s}applyTextureTransform(e,t){let s=!1,r={};(0!==t.offset.x||0!==t.offset.y)&&(r.offset=t.offset.toArray(),s=!0),0!==t.rotation&&(r.rotation=t.rotation,s=!0),(1!==t.repeat.x||1!==t.repeat.y)&&(r.scale=t.repeat.toArray(),s=!0),s&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function s(e){return e.colorSpace===r.er$?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}e instanceof r.FvD&&(e=await this.decompressTextureAsync(e)),t instanceof r.FvD&&(t=await this.decompressTextureAsync(t));let n=e?e.image:null,i=t?t.image:null,a=Math.max(n?n.width:0,i?i.width:0),o=Math.max(n?n.height:0,i?i.height:0),l=f();l.width=a,l.height=o;let c=l.getContext("2d",{willReadFrequently:!0});c.fillStyle="#00ffff",c.fillRect(0,0,a,o);let h=c.getImageData(0,0,a,o);if(n){c.drawImage(n,0,0,a,o);let t=s(e),r=c.getImageData(0,0,a,o).data;for(let e=2;e<r.length;e+=4)h.data[e]=256*t(r[e]/256)}if(i){c.drawImage(i,0,0,a,o);let e=s(t),r=c.getImageData(0,0,a,o).data;for(let t=1;t<r.length;t+=4)h.data[t]=256*e(r[t]/256)}c.putImageData(h,0,0);let u=(e||t).clone();return u.source=new r.kLi(l),u.colorSpace=r.jf0,u.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),u}async decompressTextureAsync(e,t=1/0){if(null===this.textureUtils)throw Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){let t=this.json,s=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),s.push(e),0}processBufferView(e,t,s,n,i){let o,l=this.json;switch(!l.bufferViews&&(l.bufferViews=[]),t){case a.BYTE:case a.UNSIGNED_BYTE:o=1;break;case a.SHORT:case a.UNSIGNED_SHORT:o=2;break;default:o=4}let c=e.itemSize*o;i===a.ARRAY_BUFFER&&(c=4*Math.ceil(c/4));let h=p(n*c),u=new DataView(new ArrayBuffer(h)),m=0;for(let i=s;i<s+n;i++){for(let s=0;s<e.itemSize;s++){let n;e.itemSize>4?n=e.array[i*e.itemSize+s]:(0===s?n=e.getX(i):1===s?n=e.getY(i):2===s?n=e.getZ(i):3===s&&(n=e.getW(i)),!0===e.normalized&&(n=r.cj9.normalize(n,e.array))),t===a.FLOAT?u.setFloat32(m,n,!0):t===a.INT?u.setInt32(m,n,!0):t===a.UNSIGNED_INT?u.setUint32(m,n,!0):t===a.SHORT?u.setInt16(m,n,!0):t===a.UNSIGNED_SHORT?u.setUint16(m,n,!0):t===a.BYTE?u.setInt8(m,n):t===a.UNSIGNED_BYTE&&u.setUint8(m,n),m+=o}m%c!=0&&(m+=c-m%c)}let f={buffer:this.processBuffer(u.buffer),byteOffset:this.byteOffset,byteLength:h};return void 0!==i&&(f.target=i),i===a.ARRAY_BUFFER&&(f.byteStride=c),this.byteOffset+=h,l.bufferViews.push(f),{id:l.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){let t=this,s=t.json;return s.bufferViews||(s.bufferViews=[]),new Promise(function(r){let n=new FileReader;n.readAsArrayBuffer(e),n.onloadend=function(){let e=m(n.result),i={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,r(s.bufferViews.push(i)-1)}})}processAccessor(e,t,s,n){let i,o,l=this.json;if(e.array.constructor===Float32Array)i=a.FLOAT;else if(e.array.constructor===Int32Array)i=a.INT;else if(e.array.constructor===Uint32Array)i=a.UNSIGNED_INT;else if(e.array.constructor===Int16Array)i=a.SHORT;else if(e.array.constructor===Uint16Array)i=a.UNSIGNED_SHORT;else if(e.array.constructor===Int8Array)i=a.BYTE;else if(e.array.constructor===Uint8Array)i=a.UNSIGNED_BYTE;else throw Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(void 0===s&&(s=0),(void 0===n||n===1/0)&&(n=e.count),0===n)return null;let c=function(e,t,s){let n={min:Array(e.itemSize).fill(1/0),max:Array(e.itemSize).fill(-1/0)};for(let i=t;i<t+s;i++)for(let t=0;t<e.itemSize;t++){let s;e.itemSize>4?s=e.array[i*e.itemSize+t]:(0===t?s=e.getX(i):1===t?s=e.getY(i):2===t?s=e.getZ(i):3===t&&(s=e.getW(i)),!0===e.normalized&&(s=r.cj9.normalize(s,e.array))),n.min[t]=Math.min(n.min[t],s),n.max[t]=Math.max(n.max[t],s)}return n}(e,s,n);void 0!==t&&(o=e===t.index?a.ELEMENT_ARRAY_BUFFER:a.ARRAY_BUFFER);let h=this.processBufferView(e,i,s,n,o),u={bufferView:h.id,byteOffset:h.byteOffset,componentType:i,count:n,max:c.max,min:c.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(u.normalized=!0),l.accessors||(l.accessors=[]),l.accessors.push(u)-1}processImage(e,t,s,n="image/png"){if(null!==e){let i=this,a=i.cache,o=i.json,l=i.options,c=i.pending;a.images.has(e)||a.images.set(e,{});let h=a.images.get(e),u=n+":flipY/"+s.toString();if(void 0!==h[u])return h[u];o.images||(o.images=[]);let p={mimeType:n},m=f();m.width=Math.min(e.width,l.maxTextureSize),m.height=Math.min(e.height,l.maxTextureSize);let g=m.getContext("2d",{willReadFrequently:!0});if(!0===s&&(g.translate(0,m.height),g.scale(1,-1)),void 0!==e.data){t!==r.GWd&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let s=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<s.length;t+=4)s[t+0]=e.data[t+0],s[t+1]=e.data[t+1],s[t+2]=e.data[t+2],s[t+3]=e.data[t+3];g.putImageData(new ImageData(s,e.width,e.height),0,0)}else if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)g.drawImage(e,0,0,m.width,m.height);else throw Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");!0===l.binary?c.push(d(m,n).then(e=>i.processBufferViewImage(e)).then(e=>{p.bufferView=e})):void 0!==m.toDataURL?p.uri=m.toDataURL(n):c.push(d(m,n).then(e=>new FileReader().readAsDataURL(e)).then(e=>{p.uri=e}));let y=o.images.push(p)-1;return h[u]=y,y}throw Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let s={magFilter:l[e.magFilter],minFilter:l[e.minFilter],wrapS:l[e.wrapS],wrapT:l[e.wrapT]};return t.samplers.push(s)-1}async processTextureAsync(e){let t=this.options,s=this.cache,n=this.json;if(s.textures.has(e))return s.textures.get(e);n.textures||(n.textures=[]),e instanceof r.FvD&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let i=e.userData.mimeType;"image/webp"===i&&(i="image/png");let a={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,i)};e.name&&(a.name=e.name),await this._invokeAllAsync(async function(t){t.writeTexture&&await t.writeTexture(e,a)});let o=n.textures.push(a)-1;return s.textures.set(e,o),o}async processMaterialAsync(e){let t=this.cache,s=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;s.materials||(s.materials=[]);let n={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let i=e.color.toArray().concat([e.opacity]);if(u(i,[1,1,1,1])||(n.pbrMetallicRoughness.baseColorFactor=i),e.isMeshStandardMaterial?(n.pbrMetallicRoughness.metallicFactor=e.metalness,n.pbrMetallicRoughness.roughnessFactor=e.roughness):(n.pbrMetallicRoughness.metallicFactor=0,n.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){let t=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),s={index:await this.processTextureAsync(t),texCoord:t.channel};this.applyTextureTransform(s,t),n.pbrMetallicRoughness.metallicRoughnessTexture=s}if(e.map){let t={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),n.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){let t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(n.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let t={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),n.emissiveTexture=t}}if(e.normalMap){let t={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),n.normalTexture=t}if(e.aoMap){let t={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),n.occlusionTexture=t}e.transparent?n.alphaMode="BLEND":e.alphaTest>0&&(n.alphaMode="MASK",n.alphaCutoff=e.alphaTest),e.side===r.$EB&&(n.doubleSided=!0),""!==e.name&&(n.name=e.name),this.serializeUserData(e,n),await this._invokeAllAsync(async function(t){t.writeMaterialAsync&&await t.writeMaterialAsync(e,n)});let a=s.materials.push(n)-1;return t.materials.set(e,a),a}async processMeshAsync(e){let t,s=this.cache,n=this.json,o=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,s=e.material.length;t<s;t++)o.push(e.material[t].uuid);else o.push(e.material.uuid);let l=o.join(":");if(s.meshes.has(l))return s.meshes.get(l);let c=e.geometry;t=e.isLineSegments?a.LINES:e.isLineLoop?a.LINE_LOOP:e.isLine?a.LINE_STRIP:e.isPoints?a.POINTS:e.material.wireframe?a.LINES:a.TRIANGLES;let h={},u={},p=[],m=[],f={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=c.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),c.setAttribute("normal",this.createNormalizedNormalAttribute(d)));let g=null;for(let e in c.attributes){if("morph"===e.slice(0,5))continue;let t=c.attributes[e];if(e=f[e]||e.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),s.attributes.has(this.getUID(t))){u[e]=s.attributes.get(this.getUID(t));continue}g=null;let n=t.array;"JOINTS_0"!==e||n instanceof Uint16Array||n instanceof Uint8Array?(n instanceof Uint32Array||n instanceof Int32Array)&&!e.startsWith("_")&&(console.warn(`GLTFExporter: Attribute "${e}" converted to type FLOAT.`),g=i.Utils.toFloat32BufferAttribute(t)):(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),g=new r.THS(new Uint16Array(n),t.itemSize,t.normalized));let a=this.processAccessor(g||t,c);null!==a&&(e.startsWith("_")||this.detectMeshQuantization(e,t),u[e]=a,s.attributes.set(this.getUID(t),a))}if(void 0!==d&&c.setAttribute("normal",d),0===Object.keys(u).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){let t=[],r=[],n={};if(void 0!==e.morphTargetDictionary)for(let t in e.morphTargetDictionary)n[e.morphTargetDictionary[t]]=t;for(let i=0;i<e.morphTargetInfluences.length;++i){let a={},o=!1;for(let e in c.morphAttributes){if("position"!==e&&"normal"!==e){o||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),o=!0);continue}let t=c.morphAttributes[e][i],r=e.toUpperCase(),n=c.attributes[e];if(s.attributes.has(this.getUID(t,!0))){a[r]=s.attributes.get(this.getUID(t,!0));continue}let l=t.clone();if(!c.morphTargetsRelative)for(let e=0,s=t.count;e<s;e++)for(let s=0;s<t.itemSize;s++)0===s&&l.setX(e,t.getX(e)-n.getX(e)),1===s&&l.setY(e,t.getY(e)-n.getY(e)),2===s&&l.setZ(e,t.getZ(e)-n.getZ(e)),3===s&&l.setW(e,t.getW(e)-n.getW(e));a[r]=this.processAccessor(l,c),s.attributes.set(this.getUID(n,!0),a[r])}m.push(a),t.push(e.morphTargetInfluences[i]),void 0!==e.morphTargetDictionary&&r.push(n[i])}h.weights=t,r.length>0&&(h.extras={},h.extras.targetNames=r)}let y=Array.isArray(e.material);if(y&&0===c.groups.length)return null;let x=!1;if(y&&null===c.index){let e=[];for(let t=0,s=c.attributes.position.count;t<s;t++)e[t]=t;c.setIndex(e),x=!0}let T=y?e.material:[e.material],w=y?c.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,r=w.length;e<r;e++){let r={mode:t,attributes:u};if(this.serializeUserData(c,r),m.length>0&&(r.targets=m),null!==c.index){let t=this.getUID(c.index);(void 0!==w[e].start||void 0!==w[e].count)&&(t+=":"+w[e].start+":"+w[e].count),s.attributes.has(t)?r.indices=s.attributes.get(t):(r.indices=this.processAccessor(c.index,c,w[e].start,w[e].count),s.attributes.set(t,r.indices)),null===r.indices&&delete r.indices}let n=await this.processMaterialAsync(T[w[e].materialIndex]);null!==n&&(r.material=n),p.push(r)}!0===x&&c.setIndex(null),h.primitives=p,n.meshes||(n.meshes=[]),await this._invokeAllAsync(function(t){t.writeMesh&&t.writeMesh(e,h)});let A=n.meshes.push(h)-1;return s.meshes.set(l,A),A}detectMeshQuantization(e,t){let s;if(this.extensionsUsed[o])return;switch(t.array.constructor){case Int8Array:s="byte";break;case Uint8Array:s="unsigned byte";break;case Int16Array:s="short";break;case Uint16Array:s="unsigned short";break;default:return}t.normalized&&(s+=" normalized");let r=e.split("_",1)[0];n[r]&&n[r].includes(s)&&(this.extensionsUsed[o]=!0,this.extensionsRequired[o]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let s=e.isOrthographicCamera,n={type:s?"orthographic":"perspective"};return s?n.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:n.perspective={aspectRatio:e.aspect,yfov:r.cj9.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(n.name=e.type),t.cameras.push(n)-1}processAnimation(e,t){let s=this.json,n=this.nodeMap;s.animations||(s.animations=[]);let a=(e=i.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,o=[],l=[];for(let e=0;e<a.length;++e){let s,i=a[e],h=r.Nwf.parseTrackName(i.name),u=r.Nwf.findNode(t,h.nodeName),p=c[h.propertyName];if("bones"===h.objectName&&(u=!0===u.isSkinnedMesh?u.skeleton.getBoneByName(h.objectIndex):void 0),!u||!p){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',i.name);continue}let m=i.values.length/i.times.length;p===c.morphTargetInfluences&&(m/=u.morphTargetInfluences.length),!0===i.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(s="CUBICSPLINE",m/=3):s=i.getInterpolation()===r.ljd?"STEP":"LINEAR",l.push({input:this.processAccessor(new r.THS(i.times,1)),output:this.processAccessor(new r.THS(i.values,m)),interpolation:s}),o.push({sampler:l.length-1,target:{node:n.get(u),path:p}})}return s.animations.push({name:e.name||"clip_"+s.animations.length,samplers:l,channels:o}),s.animations.length-1}processSkin(e){let t=this.json,s=this.nodeMap,n=t.nodes[s.get(e)],i=e.skeleton;if(void 0===i)return null;let a=e.skeleton.bones[0];if(void 0===a)return null;let o=[],l=new Float32Array(16*i.bones.length),c=new r.kn4;for(let t=0;t<i.bones.length;++t)o.push(s.get(i.bones[t])),c.copy(i.boneInverses[t]),c.multiply(e.bindMatrix).toArray(l,16*t);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new r.THS(l,16)),joints:o,skeleton:s.get(a)}),n.skin=t.skins.length-1}async processNodeAsync(e){let t=this.json,s=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);let n={};if(s.trs){let t=e.quaternion.toArray(),s=e.position.toArray(),r=e.scale.toArray();u(t,[0,0,0,1])||(n.rotation=t),u(s,[0,0,0])||(n.translation=s),u(r,[1,1,1])||(n.scale=r)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===u(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(n.matrix=e.matrix.elements);if(""!==e.name&&(n.name=String(e.name)),this.serializeUserData(e,n),e.isMesh||e.isLine||e.isPoints){let t=await this.processMeshAsync(e);null!==t&&(n.mesh=t)}else e.isCamera&&(n.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){let t=[];for(let r=0,n=e.children.length;r<n;r++){let n=e.children[r];if(n.visible||!1===s.onlyVisible){let e=await this.processNodeAsync(n);null!==e&&t.push(e)}}t.length>0&&(n.children=t)}await this._invokeAllAsync(function(t){t.writeNode&&t.writeNode(e,n)});let i=t.nodes.push(n)-1;return r.set(e,i),i}async processSceneAsync(e){let t=this.json,s=this.options;t.scenes||(t.scenes=[],t.scene=0);let r={};""!==e.name&&(r.name=e.name),t.scenes.push(r);let n=[];for(let t=0,r=e.children.length;t<r;t++){let r=e.children[t];if(r.visible||!1===s.onlyVisible){let e=await this.processNodeAsync(r);null!==e&&n.push(e)}}n.length>0&&(r.nodes=n),this.serializeUserData(e,r)}async processObjectsAsync(e){let t=new r.Z58;t.name="AuxScene";for(let s=0;s<e.length;s++)t.children.push(e[s]);await this.processSceneAsync(t)}async processInputAsync(e){let t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync(function(t){t.beforeParse&&t.beforeParse(e)});let s=[];for(let t=0;t<e.length;t++)e[t]instanceof r.Z58?await this.processSceneAsync(e[t]):s.push(e[t]);s.length>0&&await this.processObjectsAsync(s);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let s=0;s<t.animations.length;++s)this.processAnimation(t.animations[s],e[0]);await this._invokeAllAsync(function(t){t.afterParse&&t.afterParse(e)})}async _invokeAllAsync(e){for(let t=0,s=this.plugins.length;t<s;t++)await e(this.plugins[t])}}class y{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);let s=this.writer,r=s.json,n=s.extensionsUsed,i={};e.name&&(i.name=e.name),i.color=e.color.toArray(),i.intensity=e.intensity,e.isDirectionalLight?i.type="directional":e.isPointLight?(i.type="point",e.distance>0&&(i.range=e.distance)):e.isSpotLight&&(i.type="spot",e.distance>0&&(i.range=e.distance),i.spot={},i.spot.innerConeAngle=(1-e.penumbra)*e.angle,i.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||-1!==e.target.position.z)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),n[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},n[this.name]=!0);let a=r.extensions[this.name].lights;a.push(i),t.extensions=t.extensions||{},t.extensions[this.name]={light:a.length-1}}}class x{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;let s=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},s[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class T{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;let s=this.writer,r=s.extensionsUsed,n={};if(n.clearcoatFactor=e.clearcoat,e.clearcoatMap){let t={index:await s.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};s.applyTextureTransform(t,e.clearcoatMap),n.clearcoatTexture=t}if(n.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let t={index:await s.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};s.applyTextureTransform(t,e.clearcoatRoughnessMap),n.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){let t={index:await s.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};1!==e.clearcoatNormalScale.x&&(t.scale=e.clearcoatNormalScale.x),s.applyTextureTransform(t,e.clearcoatNormalMap),n.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=n,r[this.name]=!0}}class w{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.dispersion)return;let s=this.writer.extensionsUsed,r={};r.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=r,s[this.name]=!0}}class A{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;let s=this.writer,r=s.extensionsUsed,n={};if(n.iridescenceFactor=e.iridescence,e.iridescenceMap){let t={index:await s.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};s.applyTextureTransform(t,e.iridescenceMap),n.iridescenceTexture=t}if(n.iridescenceIor=e.iridescenceIOR,n.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],n.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let t={index:await s.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};s.applyTextureTransform(t,e.iridescenceThicknessMap),n.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=n,r[this.name]=!0}}class M{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let s=this.writer,r=s.extensionsUsed,n={};if(n.transmissionFactor=e.transmission,e.transmissionMap){let t={index:await s.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};s.applyTextureTransform(t,e.transmissionMap),n.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=n,r[this.name]=!0}}class b{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let s=this.writer,r=s.extensionsUsed,n={};if(n.thicknessFactor=e.thickness,e.thicknessMap){let t={index:await s.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};s.applyTextureTransform(t,e.thicknessMap),n.thicknessTexture=t}e.attenuationDistance!==1/0&&(n.attenuationDistance=e.attenuationDistance),n.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=n,r[this.name]=!0}}class E{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;let s=this.writer.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,s[this.name]=!0}}class R{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(h)&&!e.specularIntensityMap&&!e.specularColorMap)return;let s=this.writer,r=s.extensionsUsed,n={};if(e.specularIntensityMap){let t={index:await s.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};s.applyTextureTransform(t,e.specularIntensityMap),n.specularTexture=t}if(e.specularColorMap){let t={index:await s.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};s.applyTextureTransform(t,e.specularColorMap),n.specularColorTexture=t}n.specularFactor=e.specularIntensity,n.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=n,r[this.name]=!0}}class I{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;let s=this.writer,r=s.extensionsUsed,n={};if(e.sheenRoughnessMap){let t={index:await s.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};s.applyTextureTransform(t,e.sheenRoughnessMap),n.sheenRoughnessTexture=t}if(e.sheenColorMap){let t={index:await s.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};s.applyTextureTransform(t,e.sheenColorMap),n.sheenColorTexture=t}n.sheenRoughnessFactor=e.sheenRoughness,n.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=n,r[this.name]=!0}}class N{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;let s=this.writer,r=s.extensionsUsed,n={};if(e.anisotropyMap){let t={index:await s.processTextureAsync(e.anisotropyMap)};s.applyTextureTransform(t,e.anisotropyMap),n.anisotropyTexture=t}n.anisotropyStrength=e.anisotropy,n.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=n,r[this.name]=!0}}class S{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;let s=this.writer.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,s[this.name]=!0}}class _{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;let s=this.writer,r=s.extensionsUsed,n={};if(e.bumpMap){let t={index:await s.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};s.applyTextureTransform(t,e.bumpMap),n.bumpTexture=t}n.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=n,r[this.name]=!0}}class L{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;let s=this.writer,n=new Float32Array(3*e.count),i=new Float32Array(4*e.count),a=new Float32Array(3*e.count),o=new r.kn4,l=new r.Pq0,c=new r.PTz,h=new r.Pq0;for(let t=0;t<e.count;t++)e.getMatrixAt(t,o),o.decompose(l,c,h),l.toArray(n,3*t),c.toArray(i,4*t),h.toArray(a,3*t);let u={TRANSLATION:s.processAccessor(new r.THS(n,3)),ROTATION:s.processAccessor(new r.THS(i,4)),SCALE:s.processAccessor(new r.THS(a,3))};e.instanceColor&&(u._COLOR_0=s.processAccessor(e.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:u},s.extensionsUsed[this.name]=!0,s.extensionsRequired[this.name]=!0}}i.Utils={insertKeyframe:function(e,t){let s,r=e.getValueSize(),n=new e.TimeBufferType(e.times.length+1),i=new e.ValueBufferType(e.values.length+r),a=e.createInterpolant(new e.ValueBufferType(r));if(0===e.times.length){n[0]=t;for(let e=0;e<r;e++)i[e]=0;s=0}else if(t<e.times[0]){if(.001>Math.abs(e.times[0]-t))return 0;n[0]=t,n.set(e.times,1),i.set(a.evaluate(t),0),i.set(e.values,r),s=0}else if(t>e.times[e.times.length-1]){if(.001>Math.abs(e.times[e.times.length-1]-t))return e.times.length-1;n[n.length-1]=t,n.set(e.times,0),i.set(e.values,0),i.set(a.evaluate(t),e.values.length),s=n.length-1}else for(let o=0;o<e.times.length;o++){if(.001>Math.abs(e.times[o]-t))return o;if(e.times[o]<t&&e.times[o+1]>t){n.set(e.times.slice(0,o+1),0),n[o+1]=t,n.set(e.times.slice(o+1),o+2),i.set(e.values.slice(0,(o+1)*r),0),i.set(a.evaluate(t),(o+1)*r),i.set(e.values.slice((o+1)*r),(o+2)*r),s=o+1;break}}return e.times=n,e.values=i,s},mergeMorphTargetTracks:function(e,t){let s=[],n={},i=e.tracks;for(let e=0;e<i.length;++e){let a,o=i[e],l=r.Nwf.parseTrackName(o.name),c=r.Nwf.findNode(t,l.nodeName);if("morphTargetInfluences"!==l.propertyName||void 0===l.propertyIndex){s.push(o);continue}if(o.createInterpolant!==o.InterpolantFactoryMethodDiscrete&&o.createInterpolant!==o.InterpolantFactoryMethodLinear){if(o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(o=o.clone()).setInterpolation(r.PJ3)}let h=c.morphTargetInfluences.length,u=c.morphTargetDictionary[l.propertyIndex];if(void 0===u)throw Error("THREE.GLTFExporter: Morph target name not found: "+l.propertyIndex);if(void 0===n[c.uuid]){let e=new(a=o.clone()).ValueBufferType(h*a.times.length);for(let t=0;t<a.times.length;t++)e[t*h+u]=a.values[t];a.name=(l.nodeName||"")+".morphTargetInfluences",a.values=e,n[c.uuid]=a,s.push(a);continue}let p=o.createInterpolant(new o.ValueBufferType(1));a=n[c.uuid];for(let e=0;e<a.times.length;e++)a.values[e*h+u]=p.evaluate(a.times[e]);for(let e=0;e<o.times.length;e++){let t=this.insertKeyframe(a,o.times[e]);a.values[t*h+u]=o.values[e]}}return e.tracks=s,e},toFloat32BufferAttribute:function(e){let t=new r.THS(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let s=0,r=e.count;s<r;s++)for(let r=0;r<e.itemSize;r++)t.setComponent(s,r,e.getComponent(s,r));return t}}}}]);